# üöÄ Clean Code Refactoring Kƒ±lavuzu

## üìã √ñzet

Bu kƒ±lavuz, TEKNOFEST 2025 Eƒüitim Teknolojileri projesinde Clean Code prensiplerini uygulamak i√ßin hazƒ±rlanmƒ±≈ütƒ±r. Projenizin kod kalitesini artƒ±rmak ve s√ºrd√ºr√ºlebilirliƒüini geli≈ütirmek i√ßin adƒ±m adƒ±m bir yol haritasƒ± sunar.

## üéØ Hedefler

- ‚úÖ **SOLID Prensiplerini** uygulamak
- ‚úÖ **Clean Architecture** yapƒ±sƒ±na ge√ßmek
- ‚úÖ **Type Safety** saƒülamak
- ‚úÖ **Test Coverage** artƒ±rmak
- ‚úÖ **Kod tekrarƒ±nƒ±** azaltmak
- ‚úÖ **Performansƒ±** optimize etmek

## üõ†Ô∏è Ara√ßlar

### 1. Kod Kalitesi Analizi

```bash
# Mevcut kod kalitesini analiz et
python analyze_code_quality.py
```

Bu ara√ß size ≈üunlarƒ± saƒülar:
- üìä Detaylƒ± kod metrikleri
- üéØ ƒ∞yile≈ütirme √∂nerileri
- üìà Kalite skoru (A-F)
- üìë HTML ve JSON raporlar

### 2. Otomatik Refactoring

```bash
# Clean Code refactoring uygula
python apply_clean_code_refactoring.py
```

Bu ara√ß otomatik olarak:
- üìÅ Clean Architecture klas√∂r yapƒ±sƒ± olu≈üturur
- üîÑ Route'larƒ± ayƒ±rƒ±r
- üìù Constants mod√ºl√º ekler
- ‚ö° Exception hierarchy olu≈üturur
- üß™ Test yapƒ±sƒ±nƒ± hazƒ±rlar
- üíæ Yedekleme alƒ±r

## üìö Clean Code Prensipleri

### 1. Single Responsibility Principle (SRP)
Her sƒ±nƒ±f/fonksiyon tek bir sorumluluƒüa sahip olmalƒ±.

**‚ùå K√∂t√º:**
```python
class UserManager:
    def create_user(self, data):
        # Kullanƒ±cƒ± olu≈ütur
        # Email g√∂nder
        # Log kaydet
        # Database'e yaz
        pass
```

**‚úÖ ƒ∞yi:**
```python
class UserService:
    def __init__(self, user_repo, email_service, logger):
        self.user_repo = user_repo
        self.email_service = email_service
        self.logger = logger
    
    def create_user(self, data):
        user = self.user_repo.create(data)
        self.email_service.send_welcome(user)
        self.logger.info(f"User created: {user.id}")
        return user
```

### 2. Open/Closed Principle (OCP)
Sƒ±nƒ±flar geni≈ületmeye a√ßƒ±k, deƒüi≈üikliƒüe kapalƒ± olmalƒ±.

**‚úÖ ƒ∞yi:**
```python
from abc import ABC, abstractmethod

class QuizGenerator(ABC):
    @abstractmethod
    def generate(self, topic: str) -> Quiz:
        pass

class IRTQuizGenerator(QuizGenerator):
    def generate(self, topic: str) -> Quiz:
        # IRT algoritmasƒ± ile quiz olu≈ütur
        pass

class RandomQuizGenerator(QuizGenerator):
    def generate(self, topic: str) -> Quiz:
        # Random quiz olu≈ütur
        pass
```

### 3. Dependency Inversion Principle (DIP)
Y√ºksek seviyeli mod√ºller d√º≈ü√ºk seviyeli mod√ºllere baƒüƒ±mlƒ± olmamalƒ±.

**‚úÖ ƒ∞yi:**
```python
from typing import Protocol

class CacheProtocol(Protocol):
    async def get(self, key: str) -> Any:
        ...
    
    async def set(self, key: str, value: Any, ttl: int) -> None:
        ...

class QuizService:
    def __init__(self, cache: CacheProtocol):
        self.cache = cache  # Redis, Memory, veya ba≈üka bir cache
```

## üèóÔ∏è Yeni Klas√∂r Yapƒ±sƒ±

```
src/
‚îú‚îÄ‚îÄ domain/                 # ƒ∞≈ü mantƒ±ƒüƒ± ve entity'ler
‚îÇ   ‚îú‚îÄ‚îÄ entities/          # Student, Quiz, Question
‚îÇ   ‚îú‚îÄ‚îÄ repositories/      # Repository interface'leri
‚îÇ   ‚îî‚îÄ‚îÄ value_objects/     # Grade, Score, StudentAbility
‚îÇ
‚îú‚îÄ‚îÄ application/           # Use case'ler ve servisler
‚îÇ   ‚îú‚îÄ‚îÄ use_cases/        # GenerateQuizUseCase, CreateLearningPathUseCase
‚îÇ   ‚îú‚îÄ‚îÄ dto/              # Request/Response modelleri
‚îÇ   ‚îî‚îÄ‚îÄ services/         # Application servisleri
‚îÇ
‚îú‚îÄ‚îÄ infrastructure/       # Dƒ±≈ü baƒüƒ±mlƒ±lƒ±klar
‚îÇ   ‚îú‚îÄ‚îÄ database/        # SQLAlchemy modelleri ve repo implementasyonlarƒ±
‚îÇ   ‚îú‚îÄ‚îÄ cache/           # Redis/Memory cache
‚îÇ   ‚îî‚îÄ‚îÄ ml_models/       # Model entegrasyonlarƒ±
‚îÇ
‚îî‚îÄ‚îÄ presentation/        # API ve UI katmanlarƒ±
    ‚îî‚îÄ‚îÄ api/
        ‚îú‚îÄ‚îÄ routes/      # FastAPI route'larƒ±
        ‚îú‚îÄ‚îÄ middleware/  # Security, logging, vs.
        ‚îî‚îÄ‚îÄ dependencies/ # Dependency injection
```

## üìä Kod Kalitesi Metrikleri

### Hedef Metrikler:
- **Test Coverage**: >= %80
- **Cyclomatic Complexity**: <= 5
- **Function Length**: <= 20 satƒ±r
- **Type Hint Coverage**: >= %90
- **Docstring Coverage**: >= %90

### Mevcut Durum Analizi:
```bash
# Metrikleri kontrol et
python analyze_code_quality.py

# √áƒ±ktƒ± √∂rneƒüi:
# ‚úÖ Docstring Coverage: 65% ‚Üí Hedef: 90%
# ‚ö†Ô∏è  Type Hints: 45% ‚Üí Hedef: 90%
# ‚ùå Long Functions: 23 adet ‚Üí Hedef: 0
```

## üîÑ Refactoring Adƒ±mlarƒ±

### A≈üama 1: Hazƒ±rlƒ±k (30 dakika)
```bash
# 1. Yedekleme al
cp -r src src_backup_$(date +%Y%m%d)

# 2. Git branch olu≈ütur
git checkout -b feature/clean-code-refactoring

# 3. Baƒüƒ±mlƒ±lƒ±klarƒ± g√ºncelle
pip install black flake8 mypy pytest pre-commit
```

### A≈üama 2: Otomatik Refactoring (10 dakika)
```bash
# Refactoring aracƒ±nƒ± √ßalƒ±≈ütƒ±r
python apply_clean_code_refactoring.py

# Olu≈üturulan yapƒ±yƒ± kontrol et
tree src -d -L 3
```

### A≈üama 3: Manuel ƒ∞yile≈ütirmeler (2-3 saat)

#### 3.1 Magic Number'larƒ± Kaldƒ±r
```python
# ‚ùå K√∂t√º
if student_ability > 0.7:
    difficulty = 3

# ‚úÖ ƒ∞yi
from src.shared.constants import StudentConstants

if student_ability > StudentConstants.HIGH_ABILITY_THRESHOLD:
    difficulty = QuestionDifficulty.HARD
```

#### 3.2 Type Hint'leri Ekle
```python
# ‚ùå K√∂t√º
def generate_quiz(topic, ability, num_questions):
    pass

# ‚úÖ ƒ∞yi
from typing import List, Optional
from src.domain.entities import Quiz, Question

def generate_quiz(
    topic: str,
    ability: float,
    num_questions: int = 10
) -> Quiz:
    """
    Generate adaptive quiz using IRT.
    
    Args:
        topic: Quiz topic
        ability: Student ability level (0-1)
        num_questions: Number of questions
        
    Returns:
        Generated quiz with questions
        
    Raises:
        ValidationError: If inputs are invalid
    """
    pass
```

#### 3.3 Exception Handling ƒ∞yile≈ütir
```python
# ‚ùå K√∂t√º
try:
    result = process()
except Exception as e:
    print(f"Error: {e}")
    return None

# ‚úÖ ƒ∞yi
from src.shared.exceptions import ValidationError, BusinessLogicError
import logging

logger = logging.getLogger(__name__)

try:
    result = process()
except ValidationError as e:
    logger.warning(f"Validation failed: {e}")
    raise
except BusinessLogicError as e:
    logger.error(f"Business logic error: {e}")
    raise
```

### A≈üama 4: Test Yazma (2-3 saat)
```bash
# Test dosyalarƒ± olu≈ütur
touch tests/unit/test_quiz_service.py
touch tests/integration/test_api.py

# Testleri √ßalƒ±≈ütƒ±r
pytest tests/ -v --cov=src --cov-report=html
```

### A≈üama 5: Code Quality Kontrol√º (30 dakika)
```bash
# Format kontrol√º
black src tests --check

# Linting
flake8 src tests

# Type checking
mypy src

# Complexity check
radon cc src -s -nb

# Final analiz
python analyze_code_quality.py
```

## üß™ Test √ñrnekleri

### Unit Test:
```python
# tests/unit/test_quiz_service.py
import pytest
from unittest.mock import Mock
from src.application.services import QuizService

class TestQuizService:
    @pytest.fixture
    def quiz_service(self):
        mock_repo = Mock()
        mock_cache = Mock()
        return QuizService(mock_repo, mock_cache)
    
    async def test_generate_quiz_success(self, quiz_service):
        # Arrange
        topic = "Matematik"
        ability = 0.5
        
        # Act
        result = await quiz_service.generate_quiz(topic, ability)
        
        # Assert
        assert result is not None
        assert len(result.questions) == 10
```

### Integration Test:
```python
# tests/integration/test_api.py
from fastapi.testclient import TestClient
from src.app import app

client = TestClient(app)

def test_health_check():
    response = client.get("/api/v1/health")
    assert response.status_code == 200
    assert response.json()["status"] == "healthy"

def test_generate_quiz():
    response = client.post(
        "/api/v1/quiz/generate",
        json={
            "topic": "Fizik",
            "student_ability": 0.6,
            "num_questions": 10
        }
    )
    assert response.status_code == 201
    assert "quiz_id" in response.json()
```

## üö¶ Pre-commit Hooks

`.pre-commit-config.yaml` dosyasƒ±nƒ± kullanarak kod kalitesini otomatik kontrol edin:

```bash
# Pre-commit kurulumu
pip install pre-commit
pre-commit install

# Manuel √ßalƒ±≈ütƒ±rma
pre-commit run --all-files
```

## üìà Performans ƒ∞yile≈ütirmeleri

### 1. Caching Strategy
```python
from functools import lru_cache
from src.core.cache import redis_cache

class QuizService:
    @redis_cache(ttl=3600)  # 1 saat cache
    async def get_quiz_by_id(self, quiz_id: str) -> Quiz:
        return await self.repo.get(quiz_id)
    
    @lru_cache(maxsize=128)  # Memory cache
    def calculate_difficulty(self, ability: float) -> float:
        # CPU-intensive hesaplama
        pass
```

### 2. Database Query Optimization
```python
# Eager loading kullan
from sqlalchemy.orm import joinedload

students = session.query(Student)\
    .options(joinedload(Student.progress))\
    .filter(Student.grade == 9)\
    .all()
```

### 3. Async Operations
```python
import asyncio

async def process_students(student_ids: List[str]):
    tasks = [process_student(sid) for sid in student_ids]
    results = await asyncio.gather(*tasks)
    return results
```

## üîí G√ºvenlik ƒ∞yile≈ütirmeleri

### 1. Input Validation
```python
from pydantic import BaseModel, validator, Field

class QuizRequest(BaseModel):
    topic: str = Field(..., min_length=3, max_length=100)
    grade: int = Field(..., ge=1, le=12)
    
    @validator('topic')
    def validate_topic(cls, v):
        if not v.replace(' ', '').isalnum():
            raise ValueError('Topic must be alphanumeric')
        return v
```

### 2. SQL Injection Protection
```python
# ‚ùå K√∂t√º
query = f"SELECT * FROM users WHERE name = '{user_input}'"

# ‚úÖ ƒ∞yi
from sqlalchemy import text

query = text("SELECT * FROM users WHERE name = :name")
result = session.execute(query, {"name": user_input})
```

## üìù Checklist

Refactoring tamamlandƒ±ƒüƒ±nda kontrol edin:

- [ ] T√ºm fonksiyonlar 20 satƒ±rdan kƒ±sa
- [ ] Type hint coverage > %90
- [ ] Docstring coverage > %90
- [ ] Test coverage > %80
- [ ] Cyclomatic complexity < 5
- [ ] Magic number yok
- [ ] Exception hierarchy kullanƒ±lƒ±yor
- [ ] Dependency injection uygulanmƒ±≈ü
- [ ] Constants mod√ºl√º kullanƒ±lƒ±yor
- [ ] Pre-commit hooks aktif
- [ ] T√ºm testler ge√ßiyor
- [ ] Code quality grade A veya B

## üÜò Yardƒ±m ve Kaynaklar

### Faydalƒ± Komutlar:
```bash
# Kod formatla
black src tests

# Tip kontrol√º
mypy src --ignore-missing-imports

# Test coverage raporu
pytest --cov=src --cov-report=html
open htmlcov/index.html

# Complexity analizi
radon cc src -s -nb

# Security check
bandit -r src
```

### Kaynaklar:
- [Clean Code - Robert C. Martin](https://www.oreilly.com/library/view/clean-code-a/9780136083238/)
- [Clean Architecture - Robert C. Martin](https://www.oreilly.com/library/view/clean-architecture-a/9780134494272/)
- [SOLID Principles](https://en.wikipedia.org/wiki/SOLID)
- [Python Type Hints](https://docs.python.org/3/library/typing.html)
- [FastAPI Best Practices](https://fastapi.tiangolo.com/tutorial/)

## üéâ Sonu√ß

Clean Code refactoring s√ºrecini tamamladƒ±ƒüƒ±nƒ±zda:

1. **Kod kalitesi** artacak
2. **Bakƒ±m maliyeti** azalacak
3. **Yeni √∂zellik ekleme** kolayla≈üacak
4. **Bug sayƒ±sƒ±** azalacak
5. **Takƒ±m verimliliƒüi** artacak

Ba≈üarƒ±lar! üöÄ